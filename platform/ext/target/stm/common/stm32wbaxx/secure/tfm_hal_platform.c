/*
 * Copyright (c) 2021-2024, Arm Limited. All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *
 */
#include <string.h>
#include <stdint.h>
#include "tfm_hal_device_header.h"
#include "flash_layout.h"
#include "region_defs.h"
#include "target_cfg.h"
#include "tfm_hal_platform.h"
#include "tfm_plat_defs.h"
#include "uart_stdout.h"
#include "template/flash_otp_nv_counters_backend.h"

extern const struct memory_region_limits memory_regions;
void icache_init(void);

#ifdef TFM_OTP_DEFAULT_PROVIONNING

extern  struct flash_otp_nv_counters_region_t otp_stm_provision;
#define OTP_KEEP otp_stm_provision.init_value

#endif /*TFM_OTP_DEFAULT_PROVIONNING*/

/*
When BL2 is not activated, dummy SRAM shared data area is provided below.
This is required by Firmware Update (FWU) and Initial Attestation (IAT) services.
For more information about SRAM shared_data content please refer to trusted-firmware documentation
*/

#ifdef DEFAULT_SHARED_DATA
#define DUMMY_DATA 224
unsigned char dummy_data[DUMMY_DATA] = {
    0x16, 0x20, 0xDA, 0x00, 0x7F, 0x10, 0x5B, 0x00, 0xA5, 0x01, 0x63, 0x53, 0x50, 0x45, 0x04, 0x65,
    0x30, 0x2E, 0x30, 0x2E, 0x30, 0x05, 0x58, 0x20, 0xB3, 0x60, 0xCA, 0xF5, 0xC9, 0x8C, 0x6B, 0x94,
    0x2A, 0x48, 0x82, 0xFA, 0x9D, 0x48, 0x23, 0xEF, 0xB1, 0x66, 0xA9, 0xEF, 0x6A, 0x6E, 0x4A, 0xA3,
    0x7C, 0x19, 0x19, 0xED, 0x1F, 0xCC, 0xC0, 0x49, 0x06, 0x66, 0x53, 0x48, 0x41, 0x32, 0x35, 0x36,
    0x02, 0x58, 0x20, 0x07, 0x91, 0x15, 0xC0, 0x20, 0x5F, 0x27, 0x0C, 0x8D, 0x27, 0xEE, 0x70, 0xE3,
    0x29, 0x7E, 0x25, 0x19, 0x89, 0x4C, 0x3E, 0xF3, 0xFC, 0x0A, 0xDC, 0xFC, 0xD7, 0xF9, 0x26, 0x43,
    0x2E, 0xE3, 0x6A, 0x40, 0x20, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F,
    0x10, 0x5B, 0x00, 0xA5, 0x01, 0x63, 0x53, 0x50, 0x45, 0x04, 0x65, 0x32, 0x2E, 0x31, 0x2E, 0x31,
    0x05, 0x58, 0x20, 0xBF, 0xE6, 0xD8, 0x6F, 0x88, 0x26, 0xF4, 0xFF, 0x97, 0xFB, 0x96, 0xC4, 0xE6,
    0xFB, 0xC4, 0x99, 0x3E, 0x46, 0x19, 0xFC, 0x56, 0x5D, 0xA2, 0x6A, 0xDF, 0x34, 0xC3, 0x29, 0x48,
    0x9A, 0xDC, 0x38, 0x06, 0x66, 0x53, 0x48, 0x41, 0x32, 0x35, 0x36, 0x02, 0x58, 0x20, 0x80, 0x7F,
    0x57, 0x65, 0xEF, 0x14, 0x67, 0xAD, 0xA9, 0x9E, 0x2B, 0x24, 0x18, 0x96, 0x2C, 0xC0, 0x4A, 0x81,
    0x94, 0xD8, 0xED, 0x33, 0xA7, 0xAB, 0xD2, 0xE6, 0x5A, 0xE0, 0x7F, 0x03, 0x66, 0xDF, 0x00, 0x20,
    0x08, 0x00, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
#endif /*DEFAULT_SHARED_DATA*/

FIH_RET_TYPE(enum tfm_hal_status_t) tfm_hal_platform_init(void)
{
    enum tfm_plat_err_t plat_err = TFM_PLAT_ERR_SYSTEM_ERR;

    __enable_irq();
    stdio_init();

    plat_err = nvic_interrupt_target_state_cfg();
    if (plat_err != TFM_PLAT_ERR_SUCCESS) {
        FIH_RET(fih_int_encode(TFM_HAL_ERROR_GENERIC));
    }

#ifdef TFM_OTP_DEFAULT_PROVIONNING

    /*  Place here to force linker to keep provision and init const */
    __IO uint32_t otp = OTP_KEEP;
#endif /*TFM_OTP_DEFAULT_PROVIONNING*/

#ifdef DEFAULT_SHARED_DATA
    unsigned char *boot_data = (unsigned char *)BOOT_TFM_SHARED_DATA_BASE;
    memcpy(boot_data, dummy_data, sizeof(dummy_data));
#endif /*DEFAULT_SHARED_DATA*/

    FIH_RET(fih_int_encode(TFM_HAL_SUCCESS));
}

uint32_t tfm_hal_get_ns_VTOR(void)
{
    return memory_regions.non_secure_code_start;
}

uint32_t tfm_hal_get_ns_MSP(void)
{
    return *((uint32_t *)memory_regions.non_secure_code_start);
}

uint32_t tfm_hal_get_ns_entry_point(void)
{
    return *((uint32_t *)(memory_regions.non_secure_code_start + 4));
}

void icache_init(void)
{
    if (HAL_ICACHE_Monitor_Reset(ICACHE_MONITOR_HIT_MISS) != HAL_OK)
    {
        Error_Handler();
    }
    if (HAL_ICACHE_Monitor_Start(ICACHE_MONITOR_HIT_MISS) != HAL_OK)
    {
        Error_Handler();
    }
    /* Enable ICache */
    if (HAL_ICACHE_Enable() != HAL_OK)
    {
        Error_Handler();
    }
}